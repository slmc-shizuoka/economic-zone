<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シフト管理アプリ V9.2 (連勤・週休制限対応)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS (xlsx) for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f8fafc; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Tab Animations */
        .tab-active { border-bottom: 3px solid #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-inactive { border-bottom: 3px solid transparent; color: #6b7280; }
        .tab-inactive:hover { color: #374151; background-color: #f9fafb; }

        /* Sticky Table Headers */
        .sticky-col { position: sticky; left: 0; z-index: 20; background-color: white; }
        .sticky-header { position: sticky; top: 0; z-index: 30; }
        .sticky-corner { position: sticky; left: 0; top: 0; z-index: 40; }

        /* Animation Classes */
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- 定数・初期データ ---
        // V9系と互換性あり
        const APP_STORAGE_KEY = 'shift_app_v9_simple';

        const COLOR_OPTIONS = [
            { name: "青", class: "bg-blue-50 text-blue-700 border-blue-200" },
            { name: "橙", class: "bg-orange-50 text-orange-700 border-orange-200" },
            { name: "緑", class: "bg-green-50 text-green-700 border-green-200" },
            { name: "紫", class: "bg-purple-50 text-purple-700 border-purple-200" },
            { name: "赤", class: "bg-red-50 text-red-700 border-red-200" },
            { name: "桃", class: "bg-pink-50 text-pink-700 border-pink-200" },
            { name: "水", class: "bg-cyan-50 text-cyan-700 border-cyan-200" },
            { name: "灰", class: "bg-gray-100 text-gray-700 border-gray-300" },
            { name: "黄", class: "bg-yellow-50 text-yellow-700 border-yellow-200" },
        ];

        const DEFAULT_PRESETS = [
            { id: 1, label: "出勤", value: "9:45-18:45", color: COLOR_OPTIONS[0].class, type: 'work' },
            { id: 2, label: "公休", value: "公休",        color: COLOR_OPTIONS[4].class, type: 'holiday' },
            { id: 3, label: "有給", value: "有給",        color: COLOR_OPTIONS[5].class, type: 'holiday' }
        ];

        const DEFAULT_STAFF_LIST = [
            { id: 1, name: "佐藤", isKeyHolder: true, maxWorkDays: 22 },
            { id: 2, name: "鈴木", isKeyHolder: true, maxWorkDays: 22 },
            { id: 3, name: "田中", isKeyHolder: false, maxWorkDays: 20 },
            { id: 4, name: "高橋", isKeyHolder: false, maxWorkDays: 20 },
            { id: 5, name: "伊藤", isKeyHolder: true, maxWorkDays: 22 } 
        ];

        // --- 共通コンポーネント: トースト通知 ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgColor = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-gray-800';

            return (
                <div className={`fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-[100] flex items-center gap-3 fade-in`}>
                    <i className={`fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}`}></i>
                    <span className="font-bold">{message}</span>
                </div>
            );
        };

        // --- 共通コンポーネント: 確認モーダル ---
        const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "実行", confirmColor = "bg-indigo-600" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 fade-in transform scale-100">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">{title}</h3>
                        <p className="text-gray-600 mb-6 whitespace-pre-wrap">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 text-gray-600 font-bold hover:bg-gray-100 rounded-lg transition">キャンセル</button>
                            <button onClick={onConfirm} className={`px-4 py-2 text-white font-bold rounded-lg shadow hover:opacity-90 transition ${confirmColor}`}>
                                {confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const loadState = (key, defaultValue) => {
                try {
                    const stored = localStorage.getItem(key);
                    return stored ? JSON.parse(stored) : defaultValue;
                } catch (e) {
                    console.error("Storage load error", e);
                    return defaultValue;
                }
            };

            const [activeTab, setActiveTab] = useState('shift'); 
            const [staffList, setStaffList] = useState(() => loadState(APP_STORAGE_KEY + '_staff', DEFAULT_STAFF_LIST));
            const [presets, setPresets] = useState(() => loadState(APP_STORAGE_KEY + '_presets', DEFAULT_PRESETS));
            const [shifts, setShifts] = useState(() => loadState(APP_STORAGE_KEY + '_shifts', {}));
            const [startDate, setStartDate] = useState(() => loadState(APP_STORAGE_KEY + '_startDate', new Date().toISOString().split('T')[0]));
            const [daysCount, setDaysCount] = useState(() => loadState(APP_STORAGE_KEY + '_daysCount', 30));
            
            const [newStaffName, setNewStaffName] = useState("");
            const [newStaffIsKeyHolder, setNewStaffIsKeyHolder] = useState(false);
            const [newStaffMaxWork, setNewStaffMaxWork] = useState(22);
            const [selectedPresetValue, setSelectedPresetValue] = useState("");
            
            const [toast, setToast] = useState(null); 
            const [modalConfig, setModalConfig] = useState({ isOpen: false, title: "", message: "", onConfirm: null, confirmColor: "" });

            useEffect(() => { localStorage.setItem(APP_STORAGE_KEY + '_staff', JSON.stringify(staffList)); }, [staffList]);
            useEffect(() => { localStorage.setItem(APP_STORAGE_KEY + '_presets', JSON.stringify(presets)); }, [presets]);
            useEffect(() => { localStorage.setItem(APP_STORAGE_KEY + '_shifts', JSON.stringify(shifts)); }, [shifts]);
            useEffect(() => { localStorage.setItem(APP_STORAGE_KEY + '_startDate', JSON.stringify(startDate)); }, [startDate]);
            useEffect(() => { localStorage.setItem(APP_STORAGE_KEY + '_daysCount', JSON.stringify(daysCount)); }, [daysCount]);

            const showToast = (message, type = 'success') => setToast({ message, type });
            const openConfirm = (title, message, action, color = "bg-indigo-600", btnText = "実行") => {
                setModalConfig({
                    isOpen: true, title, message, onConfirm: () => { action(); setModalConfig(prev => ({ ...prev, isOpen: false })); },
                    onCancel: () => setModalConfig(prev => ({ ...prev, isOpen: false })), confirmColor: color, confirmText: btnText
                });
            };

            const dateList = useMemo(() => {
                const dates = [];
                const start = new Date(startDate);
                for (let i = 0; i < daysCount; i++) {
                    const d = new Date(start);
                    d.setDate(start.getDate() + i);
                    dates.push(d.toISOString().split('T')[0]);
                }
                return dates;
            }, [startDate, daysCount]);

            // Helper: 月曜起算の週の開始日を取得
            const getMondayOfWeek = (dateStr) => {
                const d = new Date(dateStr);
                const day = d.getDay(); // 0:Sun, 1:Mon...
                // 月曜ならその日、それ以外なら直前の月曜に戻す
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                const monday = new Date(d.setDate(diff));
                return monday.toISOString().split('T')[0];
            };

            const isWorkValue = (value) => {
                if (!value) return false;
                const preset = presets.find(p => p.value === value);
                if (preset && preset.type === 'holiday') return false;
                if (value.includes('公休') || value.includes('休') || value.includes('有給')) return false;
                return true;
            };

            const getCurrentWorkCount = (staffId, currentShifts) => {
                let count = 0;
                dateList.forEach(date => {
                    if (isWorkValue(currentShifts[`${staffId}_${date}`])) count++;
                });
                return count;
            };

            const countKeyHoldersOnDate = (date) => {
                let count = 0;
                staffList.forEach(staff => {
                    if (!staff.isKeyHolder) return;
                    if (isWorkValue(shifts[`${staff.id}_${date}`])) count++;
                });
                return count;
            };

            const getCellStyle = (value) => {
                if (!value) return "bg-white hover:bg-gray-50";
                const matchedPreset = presets.find(p => p.value === value);
                if (matchedPreset) return matchedPreset.color + " font-bold shadow-sm";
                if (value.includes("公休") || value.includes("休") && !value.includes("有給")) return "bg-red-50 text-red-700 font-bold border-red-100";
                if (value.includes("有給")) return "bg-pink-50 text-pink-700 font-bold border-pink-100";
                return "bg-gray-100 text-gray-800 border-gray-200";
            };

            const calculateStats = (staffId) => {
                let workCount = 0; let holidayCount = 0; let paidCount = 0;
                dateList.forEach(date => {
                    const val = shifts[`${staffId}_${date}`];
                    if (!val) return;
                    const matchedPreset = presets.find(p => p.value === val);
                    if (val.includes("有給") || (matchedPreset && matchedPreset.label.includes("有給"))) paidCount++;
                    else if (val.includes("公休") || val.includes("休") || (matchedPreset && matchedPreset.type === 'holiday')) holidayCount++;
                    else workCount++;
                });
                return { workCount, holidayCount, paidCount };
            };

            // --- 自動生成ロジック (V9.2) ---
            const generateAutoShifts = () => {
                openConfirm(
                    "シフト自動生成 (V9.2)",
                    "現在の空欄を自動的に埋めます。\n\n【適用されるルール】\n・スタッフ毎の出勤上限日数\n・鍵持ちスタッフ確保(2名)\n・最大5連勤まで (6連勤禁止)\n・週休2日確保 (月曜起算で週5日勤務まで)\n\n実行しますか？",
                    () => {
                        const newShifts = { ...shifts };
                        const workPresets = presets.filter(p => p.type === 'work');
                        const holidayPresets = presets.filter(p => p.type === 'holiday');
                        
                        if (workPresets.length === 0 || holidayPresets.length === 0) {
                            showToast("エラー: 「出勤」と「休日」のプリセットが必要です。", "error");
                            return;
                        }

                        // 制約チェック関数
                        const canAssignWork = (staffId, targetDate, currentShiftsMap) => {
                            // 1. 連勤チェック (直近5日間が全て出勤ならNG -> 6連勤禁止)
                            let consecutive = 0;
                            const d = new Date(targetDate);
                            for (let i = 1; i <= 5; i++) {
                                const prev = new Date(d);
                                prev.setDate(d.getDate() - i);
                                const prevDateStr = prev.toISOString().split('T')[0];
                                if (isWorkValue(currentShiftsMap[`${staffId}_${prevDateStr}`])) {
                                    consecutive++;
                                } else {
                                    break;
                                }
                            }
                            if (consecutive >= 5) return false;

                            // 2. 週出勤数チェック (月曜起算で週5日以上ならNG)
                            const mondayStr = getMondayOfWeek(targetDate);
                            let weeklyWorkCount = 0;
                            const monday = new Date(mondayStr);
                            for(let i = 0; i < 7; i++) {
                                const checkD = new Date(monday);
                                checkD.setDate(monday.getDate() + i);
                                const checkDateStr = checkD.toISOString().split('T')[0];
                                
                                if (checkDateStr === targetDate) continue; // 自分自身は除外

                                if (isWorkValue(currentShiftsMap[`${staffId}_${checkDateStr}`])) {
                                    weeklyWorkCount++;
                                }
                            }
                            if (weeklyWorkCount >= 5) return false;

                            return true;
                        };

                        // ワークカウント初期化
                        const workCounts = {};
                        staffList.forEach(s => {
                            workCounts[s.id] = getCurrentWorkCount(s.id, newShifts);
                        });

                        const keyHolders = staffList.filter(s => s.isKeyHolder);

                        // Phase 1: 鍵持ち確保 (日付順)
                        dateList.forEach(date => {
                            let currentKeyCount = 0;
                            keyHolders.forEach(s => {
                                if (isWorkValue(newShifts[`${s.id}_${date}`])) currentKeyCount++;
                            });

                            const needed = Math.max(0, 2 - currentKeyCount);
                            if (needed === 0) return;

                            const candidates = keyHolders.filter(s => !newShifts[`${s.id}_${date}`]);
                            candidates.sort((a, b) => {
                                const roomA = a.maxWorkDays - workCounts[a.id];
                                const roomB = b.maxWorkDays - workCounts[b.id];
                                return roomB - roomA; 
                            });

                            let assignedCount = 0;
                            for (const staff of candidates) {
                                if (assignedCount >= needed) break;
                                
                                // 制約チェック (厳格モード)
                                if (canAssignWork(staff.id, date, newShifts) && workCounts[staff.id] < staff.maxWorkDays) {
                                    newShifts[`${staff.id}_${date}`] = workPresets[Math.floor(Math.random() * workPresets.length)].value;
                                    workCounts[staff.id]++;
                                    assignedCount++;
                                }
                            }
                        });

                        // Phase 2: 残り埋め (日付順)
                        dateList.forEach(date => {
                            staffList.forEach(staff => {
                                const key = `${staff.id}_${date}`;
                                if (newShifts[key]) return; // 決定済みはスキップ

                                if (workCounts[staff.id] < staff.maxWorkDays && canAssignWork(staff.id, date, newShifts)) {
                                    // 80%の確率で出勤を試みる（ランダム性を持たせる）
                                    if (Math.random() < 0.8) {
                                        newShifts[key] = workPresets[Math.floor(Math.random() * workPresets.length)].value;
                                        workCounts[staff.id]++;
                                    } else {
                                        newShifts[key] = holidayPresets[Math.floor(Math.random() * holidayPresets.length)].value;
                                    }
                                } else {
                                    // 制約NG or 上限到達 -> 休み
                                    newShifts[key] = holidayPresets[Math.floor(Math.random() * holidayPresets.length)].value;
                                }
                            });
                        });
                        
                        setShifts(newShifts);
                        showToast("自動生成完了 (連勤・週休制限適用)");
                    },
                    "bg-gradient-to-r from-indigo-600 to-blue-600"
                );
            };

            const handleShiftChange = (staffId, date, value) => setShifts(prev => ({ ...prev, [`${staffId}_${date}`]: value }));
            const handleCellClick = (staffId, date) => {};
            const handlePresetChange = (id, field, newValue) => setPresets(prev => prev.map(p => p.id === id ? { ...p, [field]: newValue } : p));
            const updateStaffInfo = (id, field, value) => setStaffList(prev => prev.map(s => s.id === id ? { ...s, [field]: value } : s));

            const addPreset = () => {
                const newId = presets.length > 0 ? Math.max(...presets.map(p => p.id)) + 1 : 1;
                setPresets([...presets, { id: newId, label: "新規", value: "00:00-00:00", color: COLOR_OPTIONS[7].class, type: 'work' }]);
                showToast("プリセットを追加しました");
            };
            const deletePreset = (id) => openConfirm("削除", "削除しますか？", () => { setPresets(prev => prev.filter(p => p.id !== id)); if(selectedPresetValue) setSelectedPresetValue(""); }, "bg-red-600", "削除");

            const addStaff = (e) => {
                e.preventDefault();
                if (!newStaffName.trim()) return;
                const newId = staffList.length > 0 ? Math.max(...staffList.map(s => s.id)) + 1 : 1;
                setStaffList([...staffList, { id: newId, name: newStaffName, isKeyHolder: newStaffIsKeyHolder, maxWorkDays: Number(newStaffMaxWork) }]);
                setNewStaffName(""); setNewStaffIsKeyHolder(false); setNewStaffMaxWork(22); showToast("追加しました");
            };
            const removeStaff = (id, name) => openConfirm("削除", `${name}さんを削除しますか？`, () => { setStaffList(staffList.filter(s => s.id !== id)); }, "bg-red-600", "削除");
            const clearAllShifts = () => openConfirm("全消去", "全てのシフトを消去しますか？", () => { setShifts({}); showToast("消去しました"); }, "bg-red-600", "全消去");

            const exportToExcel = () => {
                try {
                    const workbook = XLSX.utils.book_new();
                    const masterHeader = ["名前", "鍵", ...dateList, "出勤", "公休", "有給", "上限"];
                    const masterData = staffList.map(staff => {
                        const stats = calculateStats(staff.id);
                        const row = [staff.name, staff.isKeyHolder ? "〇" : ""];
                        dateList.forEach(date => row.push(shifts[`${staff.id}_${date}`] || ""));
                        row.push(stats.workCount, stats.holidayCount, stats.paidCount, staff.maxWorkDays);
                        return row;
                    });
                    const masterSheet = XLSX.utils.aoa_to_sheet([masterHeader, ...masterData]);
                    XLSX.utils.book_append_sheet(workbook, masterSheet, "全体シフト");
                    XLSX.writeFile(workbook, `シフト表_${startDate}.xlsx`);
                    showToast("ダウンロード開始");
                } catch (error) { console.error(error); showToast("エラーが発生しました", "error"); }
            };

            const TabNavigation = () => (
                <div className="bg-white shadow-sm mb-6 sticky top-0 z-50 border-b border-gray-100">
                    <div className="max-w-7xl mx-auto px-4">
                        <div className="flex space-x-1 overflow-x-auto no-scrollbar">
                            {[{ id: 'shift', icon: 'fa-table', label: 'シフト作成表' }, { id: 'stats', icon: 'fa-chart-pie', label: '集計データ' }, { id: 'staff', icon: 'fa-users', label: 'スタッフ管理' }, { id: 'settings', icon: 'fa-sliders', label: '設定・保存' }].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-5 py-4 font-bold text-sm transition-all whitespace-nowrap flex items-center gap-2 outline-none ${activeTab === tab.id ? 'tab-active' : 'tab-inactive'}`}>
                                    <i className={`fa-solid ${tab.icon}`}></i> {tab.label}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );

            const ShiftTableTab = () => (
                <div className="w-full px-2 sm:px-4 max-w-[100vw] fade-in">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6 sticky top-20 z-40">
                        <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4">
                            <div className="flex flex-col sm:flex-row items-start sm:items-center gap-4 flex-1 w-full xl:w-auto">
                                <span className="text-xs font-bold text-gray-500 uppercase tracking-wider whitespace-nowrap flex-shrink-0">
                                    スタンプ入力:<br/><span className="text-[10px] font-normal text-gray-400">選択してセルをクリック</span>
                                </span>
                                <div className="flex flex-wrap gap-2">
                                    {presets.map((preset) => (
                                        <button key={preset.id} onClick={() => setSelectedPresetValue(selectedPresetValue === preset.value ? "" : preset.value)} className={`px-3 py-2 rounded-lg text-xs font-bold border transition-all shadow-sm flex flex-col items-center justify-center min-w-[60px] relative overflow-hidden ${selectedPresetValue === preset.value ? 'ring-2 ring-offset-2 ring-indigo-500 transform scale-105 z-10 ' + preset.color : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300'}`}>
                                            <span>{preset.label}</span>
                                            {selectedPresetValue === preset.value && <div className="absolute inset-0 bg-current opacity-10"></div>}
                                        </button>
                                    ))}
                                    {selectedPresetValue && <button onClick={() => setSelectedPresetValue("")} className="ml-2 text-xs text-gray-400 hover:text-red-500 underline whitespace-nowrap"><i className="fa-solid fa-xmark mr-1"></i>解除</button>}
                                </div>
                            </div>
                            <div className="flex items-center gap-3 border-t xl:border-t-0 xl:border-l pt-3 xl:pt-0 xl:pl-4 border-gray-100 w-full xl:w-auto justify-end">
                                <button onClick={generateAutoShifts} className="bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white px-5 py-2.5 rounded-lg font-bold text-sm shadow-md flex items-center whitespace-nowrap transition-transform active:scale-95"><i className="fa-solid fa-robot mr-2"></i> 自動作成</button>
                                <button onClick={clearAllShifts} className="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2.5 rounded-lg transition" title="全てクリア"><i className="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow border border-gray-200 overflow-hidden flex flex-col h-[calc(100vh-320px)] relative">
                        <div className="overflow-auto flex-1 custom-scrollbar">
                            <table className="border-collapse text-sm w-full">
                                <thead className="sticky-header bg-gray-50 shadow-sm z-30">
                                    <tr>
                                        <th className="sticky-corner bg-gray-100 p-3 text-left font-bold text-gray-600 border-b border-r min-w-[160px] shadow z-50">
                                            <div className="flex items-center justify-between"><span>スタッフ</span><span className="text-[10px] bg-gray-200 px-2 py-0.5 rounded-full">上限</span></div>
                                        </th>
                                        {dateList.map(date => {
                                            const d = new Date(date);
                                            const day = ["日", "月", "火", "水", "木", "金", "土"][d.getDay()];
                                            const color = d.getDay() === 0 ? 'text-red-600 bg-red-50' : d.getDay() === 6 ? 'text-blue-600 bg-blue-50' : 'text-gray-700 bg-gray-50';
                                            return <th key={date} className={`p-2 text-center border-b border-r border-gray-200 min-w-[60px] ${color}`}><div className="text-[10px] opacity-70 leading-none mb-1">{d.getMonth()+1}/{d.getDate()}</div><div className="text-sm font-bold leading-none">{day}</div></th>;
                                        })}
                                    </tr>
                                </thead>
                                <tbody>
                                    {staffList.map((staff) => (
                                        <tr key={staff.id} className="hover:bg-gray-50 group">
                                            <td className="sticky-col left-0 bg-white p-3 border-b border-r border-gray-100 font-medium text-gray-800 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] group-hover:bg-gray-50 z-20">
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-2"><div className={`w-2 h-8 rounded-r ${staff.isKeyHolder ? 'bg-yellow-400' : 'bg-gray-300'}`}></div><div className="flex flex-col"><span className="leading-tight">{staff.name}</span>{staff.isKeyHolder && <span className="text-[9px] text-yellow-600 font-bold">KEY</span>}</div></div>
                                                    <span className="text-xs text-gray-400 font-mono bg-gray-100 px-1.5 py-0.5 rounded">{staff.maxWorkDays}</span>
                                                </div>
                                            </td>
                                            {dateList.map(date => {
                                                const key = `${staff.id}_${date}`;
                                                const val = shifts[key] || "";
                                                return (
                                                    <td key={key} className="p-1 border-b border-r border-gray-100 relative h-12 p-0">
                                                        <input type="text" value={val} onChange={(e) => handleShiftChange(staff.id, date, e.target.value)} onClick={() => { if(selectedPresetValue) handleShiftChange(staff.id, date, selectedPresetValue); }} className={`w-full h-full text-center text-xs outline-none transition-colors focus:ring-2 focus:ring-indigo-500 focus:z-10 relative ${getCellStyle(val)} ${selectedPresetValue ? 'cursor-pointer' : 'cursor-text'}`} />
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    ))}
                                    <tr className="bg-gray-50 border-t-2 border-gray-200">
                                        <td className="sticky-col left-0 bg-gray-100 p-2 border-r font-bold text-xs text-gray-500 text-right z-20 shadow">鍵当番 (2人以上)</td>
                                        {dateList.map(date => {
                                            const count = countKeyHoldersOnDate(date);
                                            const isWarning = count < 2;
                                            return <td key={`check_${date}`} className={`text-center border-r border-gray-200 text-xs font-bold py-2 ${isWarning ? 'bg-red-100 text-red-600' : 'bg-green-50 text-green-600'}`}>{isWarning ? <i className="fa-solid fa-circle-exclamation"></i> : <i className="fa-solid fa-check"></i>} {count}</td>;
                                        })}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );

            const StatsTab = () => (
                <div className="max-w-5xl mx-auto px-4 fade-in">
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h2 className="text-lg font-bold text-gray-800"><i className="fa-solid fa-chart-pie text-indigo-500 mr-2"></i> シフト集計データ</h2>
                            <span className="text-xs text-gray-500">※自動計算されます</span>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-white text-gray-500 font-bold uppercase text-xs border-b border-gray-200">
                                    <tr><th className="px-6 py-4">スタッフ名</th><th className="px-6 py-4 text-center">出勤上限</th><th className="px-6 py-4 text-center bg-blue-50">出勤実績</th><th className="px-6 py-4 text-center">公休数</th><th className="px-6 py-4 text-center">有給数</th><th className="px-6 py-4 text-center">状態</th></tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {staffList.map(staff => {
                                        const stats = calculateStats(staff.id);
                                        const isOverWork = stats.workCount > staff.maxWorkDays;
                                        return (
                                            <tr key={staff.id} className="hover:bg-gray-50 transition">
                                                <td className="px-6 py-4 font-bold text-gray-700">{staff.name}</td>
                                                <td className="px-6 py-4 text-center font-bold text-gray-500">{staff.maxWorkDays}日</td>
                                                <td className={`px-6 py-4 text-center font-bold text-lg bg-blue-50/50 ${isOverWork ? 'text-red-600' : 'text-blue-700'}`}>{stats.workCount}</td>
                                                <td className="px-6 py-4 text-center font-bold text-red-700 text-lg">{stats.holidayCount}</td>
                                                <td className="px-6 py-4 text-center font-bold text-pink-700 text-lg">{stats.paidCount}</td>
                                                <td className="px-6 py-4 text-center text-xs">{isOverWork ? <span className="bg-red-100 text-red-700 px-3 py-1 rounded-full font-bold border border-red-200">超過</span> : <span className="bg-green-100 text-green-700 px-3 py-1 rounded-full font-bold border border-green-200">正常</span>}</td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );

            const StaffTab = () => (
                <div className="max-w-3xl mx-auto px-4 fade-in">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center"><i className="fa-solid fa-user-plus text-indigo-500 mr-2"></i> スタッフ登録・編集</h2>
                        <form onSubmit={addStaff} className="bg-gray-50 p-5 rounded-xl border border-gray-200 mb-8 shadow-inner">
                            <div className="flex flex-col md:flex-row gap-5 items-end">
                                <div className="flex-1 w-full"><label className="block text-xs font-bold text-gray-500 mb-1.5 ml-1">名前</label><input type="text" placeholder="例: 山田 太郎" value={newStaffName} onChange={(e) => setNewStaffName(e.target.value)} className="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 outline-none transition bg-white"/></div>
                                <div className="w-full md:w-32"><label className="block text-xs font-bold text-gray-500 mb-1.5 ml-1">出勤上限(日)</label><input type="number" min="1" max="31" value={newStaffMaxWork} onChange={(e) => setNewStaffMaxWork(e.target.value)} className="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 outline-none transition bg-white"/></div>
                                <div className="mb-3"><label className="flex items-center cursor-pointer select-none bg-white px-3 py-2 rounded-lg border border-gray-200 hover:border-gray-300 transition"><input type="checkbox" checked={newStaffIsKeyHolder} onChange={(e) => setNewStaffIsKeyHolder(e.target.checked)} className="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300"/><span className="ml-2 text-sm font-bold text-gray-700 flex items-center"><i className="fa-solid fa-key text-yellow-500 mr-1.5"></i> 鍵管理者</span></label></div>
                                <button className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-lg font-bold w-full md:w-auto shadow transition transform active:scale-95 whitespace-nowrap"><i className="fa-solid fa-plus mr-1"></i> 追加</button>
                            </div>
                        </form>
                        <div className="space-y-3">
                            <div className="text-xs font-bold text-gray-400 uppercase ml-2 mb-2">登録済みスタッフ ({staffList.length}名)</div>
                            {staffList.map(staff => (
                                <div key={staff.id} className="flex flex-col sm:flex-row justify-between items-center bg-white p-4 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition gap-3 group">
                                    <div className="flex items-center gap-4 w-full sm:w-auto"><div className="w-10 h-10 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center text-gray-600 font-bold border border-gray-200">{staff.name.charAt(0)}</div><div className="flex flex-col"><span className="font-bold text-gray-800 text-lg leading-tight">{staff.name}</span>{staff.isKeyHolder && <span className="text-xs text-yellow-600 font-bold flex items-center mt-0.5"><i className="fa-solid fa-key mr-1"></i> 鍵管理者</span>}</div></div>
                                    <div className="flex items-center gap-6 w-full sm:w-auto justify-between sm:justify-end border-t sm:border-t-0 pt-3 sm:pt-0 border-gray-100">
                                        <div className="flex items-center gap-2 text-sm bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-100"><span className="text-gray-500 text-xs font-bold">上限:</span><input type="number" className="w-12 border-b border-gray-300 text-center bg-transparent font-bold focus:border-indigo-500 focus:outline-none" value={staff.maxWorkDays} onChange={(e) => updateStaffInfo(staff.id, 'maxWorkDays', Number(e.target.value))}/><span className="text-gray-500 text-xs">日</span></div>
                                        <button onClick={() => removeStaff(staff.id, staff.name)} className="text-gray-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition group-hover:text-gray-400"><i className="fa-solid fa-trash-can"></i></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            const SettingsTab = () => (
                <div className="max-w-5xl mx-auto px-4 space-y-8 pb-20 fade-in">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex justify-between items-center mb-6"><div><h2 className="text-lg font-bold text-gray-800 flex items-center"><i className="fa-solid fa-pen-to-square text-indigo-500 mr-2"></i> シフトパターン編集</h2><p className="text-xs text-gray-500 mt-1">ここで設定したパターンが自動生成で使用されます</p></div><button onClick={addPreset} className="bg-white border border-indigo-600 text-indigo-600 hover:bg-indigo-50 px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition flex items-center"><i className="fa-solid fa-plus mr-2"></i> 新規追加</button></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                            {presets.map((preset) => (
                                <div key={preset.id} className={`relative p-5 rounded-xl border-2 transition-all ${preset.color.replace('text-', 'border-').split(' ')[2] || 'border-gray-200'} bg-white shadow-sm hover:shadow-md group`}>
                                    <button onClick={() => deletePreset(preset.id)} className="absolute top-3 right-3 w-8 h-8 flex items-center justify-center rounded-full text-gray-300 hover:bg-red-50 hover:text-red-500 transition opacity-0 group-hover:opacity-100" title="削除"><i className="fa-solid fa-trash-can"></i></button>
                                    <div className="space-y-4">
                                        <div><label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-1">表示ラベル</label><input type="text" value={preset.label} onChange={(e) => handlePresetChange(preset.id, 'label', e.target.value)} className="w-full font-bold text-gray-800 text-lg border-b border-gray-200 focus:border-indigo-500 outline-none pb-1 bg-transparent"/></div>
                                        <div><label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-1">値 (時間など)</label><input type="text" value={preset.value} onChange={(e) => handlePresetChange(preset.id, 'value', e.target.value)} className="w-full text-sm p-2 bg-gray-50 rounded border border-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none"/></div>
                                        <div className="flex items-center gap-4"><div className="flex-1"><label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">タイプ</label><div className="flex rounded-md shadow-sm" role="group"><button onClick={() => handlePresetChange(preset.id, 'type', 'work')} className={`flex-1 py-1.5 text-xs font-bold rounded-l border ${preset.type === 'work' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-500 border-gray-300 hover:bg-gray-50'}`}>出勤</button><button onClick={() => handlePresetChange(preset.id, 'type', 'holiday')} className={`flex-1 py-1.5 text-xs font-bold rounded-r border-t border-b border-r ${preset.type === 'holiday' ? 'bg-red-500 text-white border-red-500' : 'bg-white text-gray-500 border-gray-300 hover:bg-gray-50'}`}>休日</button></div></div></div>
                                        <div><label className="text-[10px] font-bold text-gray-400 uppercase mb-2 block">カラーテーマ</label><div className="flex flex-wrap gap-2">{COLOR_OPTIONS.map((opt, idx) => (<button key={idx} onClick={() => handlePresetChange(preset.id, 'color', opt.class)} className={`w-6 h-6 rounded-full border border-gray-200 transition-transform hover:scale-110 ${opt.class.split(' ')[0]} ${preset.color === opt.class ? 'ring-2 ring-offset-2 ring-gray-400 scale-110' : ''}`}></button>))}</div></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center"><i className="fa-solid fa-calendar-days text-gray-400 mr-2"></i> 期間設定</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div><label className="block text-sm font-bold text-gray-700 mb-2">シフト開始日</label><input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="w-full border rounded-lg p-3 outline-none focus:ring-2 focus:ring-indigo-500 transition"/></div>
                            <div><label className="block text-sm font-bold text-gray-700 mb-2">表示日数</label><select value={daysCount} onChange={(e) => setDaysCount(Number(e.target.value))} className="w-full border rounded-lg p-3 outline-none focus:ring-2 focus:ring-indigo-500 bg-white transition cursor-pointer"><option value={14}>2週間 (14日)</option><option value={28}>4週間 (28日)</option><option value={30}>30日</option><option value={31}>31日</option></select></div>
                        </div>
                    </div>
                    <div className="bg-gradient-to-r from-emerald-500 to-teal-500 p-8 rounded-2xl shadow-lg text-center text-white relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-full bg-white opacity-10 transform -skew-x-12"></div><h2 className="text-2xl font-bold mb-2 relative z-10">シフト表を保存する</h2><p className="mb-6 opacity-90 relative z-10 text-sm">作成したシフト表をExcel形式でダウンロードします</p>
                        <button onClick={exportToExcel} className="bg-white text-emerald-600 hover:bg-gray-100 px-8 py-3 rounded-full shadow-lg font-bold transition transform hover:-translate-y-1 relative z-10 flex items-center justify-center mx-auto"><i className="fa-solid fa-file-excel mr-2 text-xl"></i> Excelダウンロード</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-50 pb-12 font-sans text-gray-900">
                    <TabNavigation /><main className="w-full animate-fade-in">{activeTab === 'shift' && <ShiftTableTab />}{activeTab === 'stats' && <StatsTab />}{activeTab === 'staff' && <StaffTab />}{activeTab === 'settings' && <SettingsTab />}</main>
                    <ConfirmDialog {...modalConfig} />{toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>